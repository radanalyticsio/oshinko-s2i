LOCAL_IMAGE ?= radanalytics-pyspark-inc

# If you are going to push the built image to a registry
# using the "push" make target then you should replace
# "project" with an appropriate path for your registry and/or project
PUSH_IMAGE=project/radanalytics-pyspark-inc

DOCKERFILE_CONTEXT=pyspark-build-inc

.PHONY: build push clean clean-context context zero-tarballs

build: $(DOCKERFILE_CONTEXT)
	docker build --pull -t $(LOCAL_IMAGE) $(DOCKERFILE_CONTEXT)

push: build
	docker tag $(LOCAL_IMAGE) $(PUSH_IMAGE)
	docker push $(PUSH_IMAGE)

clean: clean-context
	-docker rmi $(LOCAL_IMAGE) $(PUSH_IMAGE)

clean-context:
	-rm image.pyspark-inc.yaml
	-rm -rf $(DOCKERFILE_CONTEXT)/*

context: $(DOCKERFILE_CONTEXT)

$(DOCKERFILE_CONTEXT): image.pyspark-inc.yaml $(DOCKERFILE_CONTEXT)/Dockerfile $(DOCKERFILE_CONTEXT)/modules

$(DOCKERFILE_CONTEXT)/Dockerfile $(DOCKERFILE_CONTEXT)/modules:
	- mkdir -p $(DOCKERFILE_CONTEXT)
	concreate generate --descriptor image.pyspark-inc.yaml
	cp -R target/image/* $(DOCKERFILE_CONTEXT)
	- rm $(DOCKERFILE_CONTEXT)/spark*.tgz

image.pyspark-inc.yaml:
	./no-spark-yaml.sh image.pyspark.yaml image.pyspark-inc.yaml
	
zero-tarballs:
	find ./$(DOCKERFILE_CONTEXT) -name "*.tgz" -type f -exec truncate -s 0 {} \;
	find ./$(DOCKERFILE_CONTEXT) -name "*.tar.gz" -type f -exec truncate -s 0 {} \;
